<!DOCTYPE html>
<html lang="pt-br">
<link rel="stylesheet" href="/styles/register.css" />

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <title>
        <%- title = "Cadastro" %>
    </title>
</head>

<body class="d-flex align-items-center justify-content-center w-100 vh-100" style="margin-top: 6rem;margin-bottom: 6rem;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card w-100 shadow-lg">
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <svg width="96" height="96" viewBox="0 0 96 96" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_2128_80)">
                                    <path d="M48 0C21.489 0 0 21.489 0 48C0 74.511 21.489 96 48 96C74.511 96 96 74.511 96 48C96 21.489 74.511 0 48 0ZM48 91.2C24.141 91.2 4.8 71.859 4.8 48C4.8 24.141 24.141 4.8 48 4.8C71.859 4.8 91.2 24.141 91.2 48C91.2 71.859 71.859 91.2 48 91.2ZM85.44 54.36V58.56H71.79V37.56H76.59V54.48L85.44 54.36ZM22.44 58.56C27.324 58.554 31.434 55.245 32.652 50.745L32.67 50.67L44.67 60L56.67 50.67V58.56H70.29V54.36H61.35V37.44H56.55V45.33L45 54.3L42.42 52.29L48 48L54 43.32L50.58 40.68L39.12 49.68L36.57 47.67L48.03 38.67L44.58 36L32.58 45.33C31.344 40.755 27.234 37.446 22.35 37.44H13.83V58.44L22.44 58.56ZM18.66 54.36V41.64H22.41C25.623 41.766 28.182 44.403 28.182 47.637C28.182 47.766 28.179 47.892 28.17 48.018V48C28.176 48.108 28.182 48.237 28.182 48.363C28.182 51.597 25.626 54.231 22.422 54.357H22.41L18.66 54.36Z" fill="#0672CB" />
                                </g>
                                <defs>
                                    <clipPath id="clip0_2128_80">
                                        <rect width="96" height="96" fill="white" />
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                        <form onsubmit="createUser(event)" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="name">Nome <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" placeholder="Nome" required />
                            </div>
                            <div class="form-group">
                                <label for="email">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" placeholder="Email" required />
                            </div>
                            <div class="form-group" id="permission-group" style="display: none;">
                                <label for="permission">Permissão <span class="text-danger">*</span></label>
                                <select name="permission" id="permission" class="form-control">
                                    <option value="0">Montador</option>
                                    <option value="1">Engenheiro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="line">Linha de Montagem<span class="text-danger">*</span></label>
                                <select name="line" id="line" class="form-control">
                                    <% lines.forEach(function(line) { %>
                                    <option value="<%= line.id %>"><%= line.name %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="form-group position-relative">
                                <label for="password">Senha <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="password" placeholder="Senha" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Foto de Perfil <span class="text-danger">*</span></label>
                                <img id="imagePreview" src="" alt="Preview da Foto de Perfil" style="display: none;width:100px;height:100px;border-radius:3px;object-fit:fill;" />
                                <div class="mt-1">
                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('file').click()">
                                        <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-2">
                                            <g clip-path="url(#clip0_4036_664)">
                                                <path d="M19.5956 10.5V19.6875H1.40438V10.5H0V21H21V10.5H19.5956ZM9.80437 2.86125V16.065H11.2087V2.86125L15.8288 7.95375L16.8656 7.00875L10.5 0L4.1475 7.00875L5.25 7.95375L9.80437 2.86125Z" fill="#0163B8" />
                                            </g>
                                            <defs>
                                                <clipPath id="clip0_4036_664">
                                                    <rect width="21" height="21" fill="white" />
                                                </clipPath>
                                            </defs>
                                        </svg>
                                        <span>Procurar Arquivo</span>
                                    </button>
                                    <input type="file" id="file" name="file" style="display: none;" onchange="verificarFormato(this)">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <a href="/change-password" class="text-primary">Esqueceu a senha?</a>
                                <a href="/login" class="text-primary">Já tem cadastro?</a>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">CADASTRAR</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        async function createUser(event) {
            event.preventDefault();

            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const team = document.getElementById("line").value;
            const permission = document.getElementById("permission").value;
            const file = document.getElementById('file').files[0];

            if (!file) {
                alert("Adicione uma foto de perfil.")
                return false;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('email', email);
            formData.append('password', password);
            formData.append('permission', permission);
            formData.append('team', team);
            formData.append('profile_photo', file);

            try {
                const response = await fetch("/api/register", {
                    method: "POST",
                    body: formData,
                });
                if (response.ok) {
                    alert("Usuário cadastrado com sucesso.")
                    window.location.href = '/login';
                    return;
                }
                const errorData = await response.json();
                alert(errorData.error)
            } catch (error) {
                alert("Erro ao criar usuário.");
            }
        }

        function verificarFormato(i) {
            var path = i.value;
            var extensoes = /(.jpg|.jpeg|.png|.gif)$/i;
            if (!extensoes.exec(path)) {
                alert('Insira uma imagem válida!');
                i.value = '';
                return false;
            }
            return true;
        }

        const fileInput = document.getElementById("file");
        const imagePreview = document.getElementById("imagePreview");

        fileInput.addEventListener("change", () => {
            if (verificarFormato(fileInput)) {
                const file = fileInput.files[0];
                if (file && file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        imagePreview.src = reader.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert("Por favor, selecione um arquivo de imagem.");
                    fileInput.value = '';
                    imagePreview.src = '';
                    imagePreview.style.display = 'none';
                }
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            let token = localStorage.getItem('access_token');
            if (token) {
                try {
                    const profileResponse = await fetch('/profile', {
                        method: 'GET',
                        headers: {
                            'Authorization': token,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!profileResponse.ok) {
                        throw new Error('Erro ao buscar dados do usuário');
                    }

                    const user = await profileResponse.json();

                    if (user.isAdmin) {
                        document.getElementById('permission-group').style.display = 'block';
                    } else {
                        document.getElementById('permission-group').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    document.getElementById('permission-group').style.display = 'none';
                }
            } else {
                document.getElementById('permission-group').style.display = 'none';
            }
        });
    </script>
</body>

</html>